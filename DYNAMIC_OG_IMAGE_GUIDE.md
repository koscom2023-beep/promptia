# 동적 OG 이미지 시스템 가이드

## 개요

프롬프티아의 바이럴 확산을 위한 동적 OpenGraph 이미지 생성 시스템입니다.
각 작품마다 맞춤형 OG 이미지를 생성하여 SNS 공유 시 클릭률을 높입니다.

## 주요 기능

### 1. 동적 이미지 생성

- `@vercel/og`를 사용한 서버 사이드 이미지 생성
- Edge Runtime으로 빠른 응답 속도
- 작품 제목, 작가, 썸네일을 포함한 맞춤형 디자인

### 2. Cloudflare 이미지 최적화

- Cloudflare Image Resizing API를 통한 이미지 최적화
- R2 이미지에 자동으로 리사이징 파라미터 적용
- 비용 절감 및 성능 최적화

### 3. 법규 준수

- 우측 하단에 "AI Generated by Promptia" 문구 자동 삽입
- 0.3 투명도로 디자인과 조화
- AI 생성 콘텐츠 명시

## 아키텍처

### API 엔드포인트

```
GET /api/og?title=작품제목&author=작가명&imageUrl=썸네일URL&type=novel
```

### 쿼리 파라미터

| 파라미터 | 타입 | 필수 | 설명 |
|----------|------|------|------|
| `title` | string | ✅ | 작품 제목 |
| `author` | string | ❌ | 작가 이름 (기본값: "프롬프티아 작가") |
| `imageUrl` | string | ❌ | 썸네일 이미지 URL |
| `type` | string | ❌ | 작품 유형 ('novel', 'webtoon', 'video', 기본값: 'novel') |

### 응답

- **형식**: PNG 이미지
- **크기**: 1200x630px (OG 이미지 표준)
- **런타임**: Edge Runtime

## 사용 방법

### 1. 메타데이터에서 사용

```typescript
// app/(platform)/novels/[id]/[episodeId]/page.tsx
const ogImageUrl = `${siteUrl}/api/og?${new URLSearchParams({
  title: novel.title,
  author: "작가명",
  type: novel.type || "novel",
  imageUrl: novel.thumbnail_url || "",
}).toString()}`;

return {
  openGraph: {
    images: [
      {
        url: ogImageUrl,
        width: 1200,
        height: 630,
        alt: novel.title,
        type: "image/png",
      },
    ],
  },
};
```

### 2. 직접 URL 생성

```typescript
import { getOptimizedCloudflareImage } from "@/lib/cloudflare-loader";

const imageUrl = "https://pub-xxxxx.r2.dev/image.jpg";
const optimizedUrl = getOptimizedCloudflareImage(imageUrl, {
  width: 1200,
  quality: 90,
  format: "auto",
});

const ogUrl = `${siteUrl}/api/og?title=작품제목&imageUrl=${encodeURIComponent(optimizedUrl)}`;
```

## Cloudflare 이미지 최적화

### 로더 함수

```typescript
import { cloudflareImageLoader } from "@/lib/cloudflare-loader";

// OG 이미지용 (1200x630)
const ogImageUrl = cloudflareOGImageLoader(originalUrl);

// 썸네일용 (400px)
const thumbnailUrl = cloudflareThumbnailLoader(originalUrl, 400);
```

### 이미지 변환 파라미터

Cloudflare Transform Rules 또는 Workers를 통해 다음 파라미터를 지원:

- `width`: 이미지 너비 (픽셀)
- `height`: 이미지 높이 (픽셀)
- `quality`: 이미지 품질 (1-100)
- `format`: 이미지 포맷 ('auto', 'webp', 'jpeg', 'png', 'avif')

### Cloudflare Workers 설정 (선택사항)

더 정교한 이미지 변환을 위해 Cloudflare Workers를 설정할 수 있습니다:

```javascript
// workers/image-resize.js
export default {
  async fetch(request) {
    const url = new URL(request.url);
    const imageUrl = url.searchParams.get('url');
    
    // Cloudflare Images API 또는 Transform Rules 사용
    // ...
  }
}
```

## 디자인 시스템

### 작품 유형별 색상

| 유형 | 색상 | 배경 그라데이션 |
|------|------|----------------|
| 소설 | #5eead4 | #667eea → #764ba2 |
| 웹툰 | #fbbf24 | #f093fb → #f5576c |
| 영상 | #ef4444 | #fa709a → #fee140 |

### 레이아웃

- **크기**: 1200x630px
- **폰트**: 시스템 폰트 (Noto Sans KR 추천)
- **제목**: 72px, 굵게, 최대 2줄
- **작가**: 32px
- **법규 문구**: 20px, 우측 하단, 0.3 투명도

## 성능 최적화

### Edge Runtime

- Edge Runtime 사용으로 전 세계 어디서나 빠른 응답
- 이미지 생성 시간: ~100-200ms

### 캐싱

- Vercel Edge Network에서 자동 캐싱
- 동일한 파라미터로 재요청 시 캐시된 이미지 반환

### 이미지 최적화

- Cloudflare를 통한 이미지 리사이징
- WebP/AVIF 자동 변환
- 품질 최적화

## 문제 해결

### 이미지가 생성되지 않음

1. 쿼리 파라미터 확인 (특히 `title` 필수)
2. Edge Runtime 지원 확인
3. `@vercel/og` 패키지 설치 확인

### Cloudflare 이미지 최적화가 작동하지 않음

1. R2 Public URL 확인
2. Cloudflare Transform Rules 설정 확인
3. Workers 설정 확인 (선택사항)

### 폰트가 제대로 표시되지 않음

1. 시스템 폰트 사용 (기본)
2. 또는 CDN에서 폰트 로드:
   ```typescript
   const font = await fetch(
     new URL('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900', import.meta.url)
   ).then((res) => res.arrayBuffer());
   ```

## 예시

### 기본 OG 이미지

```
/api/og?title=재벌집%20막내%20AI&author=프롬프티아&type=novel
```

### 썸네일 포함 OG 이미지

```
/api/og?title=재벌집%20막내%20AI&author=프롬프티아&type=novel&imageUrl=https://pub-xxxxx.r2.dev/thumbnail.jpg
```

### 웹툰 OG 이미지

```
/api/og?title=AI%20웹툰&author=작가명&type=webtoon&imageUrl=https://...
```

## 참고 자료

- [@vercel/og 문서](https://vercel.com/docs/concepts/functions/edge-functions/og-image-generation)
- [Cloudflare Image Resizing](https://developers.cloudflare.com/images/)
- [OpenGraph 프로토콜](https://ogp.me/)
- [Twitter Cards](https://developer.twitter.com/en/docs/twitter-for-websites/cards/overview/abouts-cards)
